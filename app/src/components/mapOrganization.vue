<template>
	<div class="addOrganization">
		<div class="row">
			<div class="card blue lighten-5 col m10 s12 offset-m1">
				<div class="card-content">
					<div class="row">
						<form class="col s12">

							<div class="row">
								<div class="input-field col s6">
									<label for="searchInput">Buscar: {{ message }}</label>
									
									<br>
									<input id="searchInput" type="text" v-model="message" placeholder="Buscar">
									<a class="waves-effect waves-light btn blue darken-4"  v-on:click="search(message)">Buscar</a>
								</div>

							</div>
						</form>
					</div>
				</div>
				<div id="map" class="map"></div>
			</div>

		</div>

	</div>



</template>

<script>
	var swal = require('sweetalert');
	var config = require('../../config.js');
	var L = require('../../lib/leaflet/leaflet-src.js');

	L.Icon.Default.imagePath = '/lib/leaflet/images';
	var Vue = require('vue');
	var gps = [];
	var map = {};
	var polydep = [];
	module.exports = {
		name: 'mapOrganization',
		data: function(){
			return {
				L : {},
				organizations: [],
				message: {},
				projects: [],
				polydep: []

			}
		},

		props: ['msg'],
		ready: function(){


			this.message = "";
			this.getOrganizations();




		},
		methods: {


			search: function () {
				for (var i = 0; i < gps.length; i++) {
					map.removeLayer(gps[i][0]);
				}
				for (var i = 0; i < polydep.length; i++) {
					map.removeLayer(polydep[i]);
				}
				polydep=[];
				for (var i = 0; i < gps.length; i++) {
					for (var j = 0; j < gps[i].length; j++) {
						//console.log(gps[i][j]);
						if (this.message == gps[i][j]) {
							this.$http.get(config.baseUrl() + '/v1/organization/'+gps[i][11]+'/projects/').then(function(response){
								this.projects = response.json();
								for (var k = 0; k < this.projects.length; k++) {
									this.addPoly(this.projects[k]);
								}
							}, function(error){
								swal('Error', 'Error obteniendo los proyectos del servidor', 'error');
							});


							var LamMarker = L.marker([gps[i][0].getLatLng().lat, gps[i][0].getLatLng().lng]).bindPopup($('<a href="#/organization/view/'+gps[i][11]+'" class="speciallink">Ver Informacion de la Organizacion</a>')[0]).addTo(map);
							gps[i][0] = LamMarker;
							
						}
					}
					console.log("termina arreglo")
				}


					


			},


			addPoly: function(project){
				var polygon;
				if (project.department=="Atlántida") {
					polygon = L.polygon([[15.91181, -87.70944],[15.84841, -87.74789],[15.7982, -87.76711],[15.73212, -87.7424],[15.64221, -87.65725],[15.5311, -87.60781],[15.52316, -87.41555],[15.45964, -87.37161],[15.44111, -87.32766],[15.45699, -87.19857],[15.55591, -86.89641],[15.59691, -86.55583],[15.55988, -86.34709],[15.66436, -86.31962],[15.7873, -86.40339],[15.91412, -87.70939]]).addTo(map).bindTooltip("Atlántida");
				} else if (project.department=="Colón") {
					polygon = L.polygon([[15.97783, -84.98483],[15.96727, -85.09744],[15.86954, -85.37759],[15.86426, -85.51492],[16.03064, -86.0093],[15.9435, -85.90219],[15.89332, -86.13839],[15.80877, -86.34439],[15.78763, -86.39657],[15.70039, -86.36361],[15.62634, -86.31967],[15.53375, -86.32241],[15.50199, -86.20431],[15.40139, -86.22079],[15.36167, -86.21804],[15.57344, -85.78683],[15.63163, -85.68246],[15.50199, -85.47647],[15.45169, -85.27871],[15.28485, -85.2485],[15.1921, -84.99856],[15.97783, -84.99032]]).addTo(map).bindTooltip("Colón");


				} else if (project.department=="Comayagua") {
					polygon = L.polygon([
						[15.02902, -87.73064],[15.03565, -87.65236],[15.01841, -87.58919],[15.04892, -87.54936],[15.03168, -87.51778],[14.99719, -87.5013],[14.97198, -87.46147],[14.93085, -87.44225],[14.9136, -87.42165],[14.93218, -87.37907],[14.93881, -87.35847],[14.93085, -87.30904],[14.92422, -87.2802],[14.90299, -87.24724],[14.83264, -87.2541],[14.78351, -87.24998],[14.73305, -87.27196],[14.68258, -87.3159],[14.6467, -87.34062],[14.61216, -87.33788],[14.61747, -87.37907],[14.58824, -87.39006],[14.55102, -87.39555],[14.53906, -87.43401],[14.49784, -87.45049],[14.46061, -87.41615],[14.43136, -87.38457],[14.38613, -87.37633],[14.34356, -87.37907],[14.30897, -87.41753],[14.28368, -87.44225],[14.24375, -87.42027],[14.20781, -87.42165],[14.18784, -87.44499],[14.15988, -87.46696],[14.12659, -87.49306],[14.12259, -87.52052],[14.12126, -87.5631],[14.09995, -87.60017],[14.06798, -87.61253],[14.05733, -87.65236],[14.06798, -87.70042],[14.10261, -87.743],[14.11727, -87.7787],[14.15855, -87.77046],[14.17453, -87.79793],[14.20249, -87.80891],[14.20115, -87.76909],[14.23843, -87.7581],[14.23577, -87.6963],[14.25174, -87.65785],[14.26771, -87.61803],[14.30231, -87.60841],[14.31429, -87.61116],[14.33824, -87.63863],[14.34356, -87.67159],[14.35154, -87.73064],[14.36219, -87.7993],[14.38347, -87.83501],[14.41274, -87.83638],[14.4287, -87.82127],[14.44997, -87.84462],[14.48987, -87.88994],[14.54304, -87.9174],[14.57362, -87.9435],[14.59488, -87.95311],[14.61614, -88.01765],[14.62943, -88.05336],[14.68258, -88.05336],[14.73305, -88.04787],[14.76227, -88.00255],[14.78086, -87.98195],[14.83264, -87.90779],[14.91626, -87.78282],[14.95872, -87.71965],[14.97464, -87.71828],[14.98392, -87.74162],[15.02372, -87.73064]]).addTo(map).bindTooltip("Comayagua");


				} else if (project.department=="Copán") {
					polygon = L.polygon([[15.30571, -88.7476],[15.28319, -88.71464],[15.20502, -88.67207],[15.12814, -88.6295],[15.08704, -88.60066],[15.02471, -88.66108],[14.92521, -88.65147],[14.80841, -88.68306],[14.73272, -88.65971],[14.69021, -88.77507],[14.55069, -88.70503],[14.53474, -88.7888],[14.52011, -88.86708],[14.63043, -88.9275],[14.73272, -89.00578],[14.71811, -89.12938],[14.82169, -89.2104],[14.90133, -89.19804],[14.99022, -89.15684],[14.99951, -89.18431],[15.10163, -89.07719],[15.30439, -88.74211]]).addTo(map).bindTooltip("Copán");


				} else if (project.department=="Cortes") {
					polygon = L.polygon([
						[15.91544, -87.7039],[15.85997, -87.73137],[15.80051, -87.77394],[15.72253, -87.74373],[15.70006, -87.80415],[15.64188, -87.78492],[15.58766, -87.7657],[15.52812, -87.80827],[15.44872, -87.81239],[15.39973, -87.83574],[15.33882, -87.87694],[15.23947, -87.91951],[15.15863, -87.80003],[15.11091, -87.7245],[14.9544, -87.72725],[14.79115, -87.97581],[14.90796, -88.04585],[15.05919, -88.02113],[15.21164, -88.05134],[15.34942, -88.1049],[15.49504, -88.22026],[15.52548, -88.46196],[15.72386, -88.22438],[15.68155, -88.15297],[15.68684, -88.11314],[15.75294, -88.05821],[15.81505, -87.94423],[15.90091, -87.822],[15.91808, -87.71489]]).addTo(map).bindTooltip("Cortes");


				} else if (project.department=="Choluteca") {
					polygon = L.polygon([
						[13.74372, -87.37706],[13.69036, -87.37568],[13.65433, -87.21638],[13.56891, -87.18205],[13.51417, -87.07219],[13.49147, -87.03785],[13.63297, -86.89641],[13.66233, -86.7838],[13.64765, -86.75496],[13.57958, -86.76732],[13.55289, -86.74672],[13.43136, -86.7165],[13.39663, -86.74534],[13.3619, -86.7014],[13.29642, -86.70552],[13.26835, -86.74946],[13.30978, -86.82911],[13.29642, -86.86619],[13.25498, -86.90739],[13.16273, -86.92662],[13.06911, -86.94722],[13.01827, -86.97331],[12.9875, -87.03923],[13.00222, -87.07905],[12.98883, -87.30702],[13.08115, -87.36332],[13.0972, -87.33449],[13.11058, -87.42238],[13.22959, -87.44984],[13.27102, -87.51164],[13.34453, -87.44023],[13.43136, -87.33311],[13.5422, -87.3853],[13.6263, -87.43336],[13.71304, -87.44984],[13.73838, -87.38118]]).addTo(map).bindTooltip("Choluteca");


				} else if (project.department=="El Paraíso") {
					polygon = L.polygon([
						[14.39544, -86.67672],[14.34223, -86.71792],[14.289, -86.80856],[14.17453, -86.86624],[14.06265, -86.92941],[13.96939, -86.90194],[13.9454, -86.96237],[13.80141, -86.9761],[13.74005, -87.03103],[13.74539, -87.11343],[13.68402, -87.09146],[13.63598, -87.20681],[13.57458, -87.17111],[13.50248, -87.04202],[13.63598, -86.87173],[13.76406, -86.76187],[13.78007, -86.50918],[13.78274, -86.32516],[13.99604, -86.14938],[14.07864, -86.00381],[13.98005, -86.03677],[13.83341, -85.73464],[13.94806, -85.75936],[14.01736, -85.60281],[14.05733, -85.54513],[14.19317, -86.10269],[14.34223, -86.21255],[14.31562, -86.36361],[14.39544, -86.67672]]).addTo(map).bindTooltip("El Paraíso");


				} else if (project.department=="Francisco Morazán") {
					polygon = L.polygon([[15.00117, -86.91842],[14.80741, -86.86074],[14.62412, -86.81405],[14.48854, -86.67672],[14.36352, -86.68771],[14.19849, -86.858],[14.02269, -86.91293],[13.84941, -86.96786],[13.69202, -87.0942],[13.6253, -87.20132],[13.67334, -87.35238],[13.66, -87.44576],[13.91341, -87.58584],[14.1186, -87.55837],[14.30497, -87.42379],[14.4646, -87.41281],[14.65335, -87.33865],[14.83397, -87.22329],[14.99852, -87.13265],[15.00382, -86.92941]]).addTo(map).bindTooltip("Francisco Morazán");


				} else if (project.department=="Gracias a Dios") {
					polygon = L.polygon([
						[15.97519, -84.99307],[14.72242, -84.99856],[14.83131, -84.82827],[14.70117, -84.70193],[14.64538, -84.56185],[14.62412, -84.441],[14.70649, -84.35586],[14.65069, -84.27072],[14.74368, -84.10592],[14.75696, -83.91091],[14.81538, -83.70767],[14.97994, -83.50442],[14.96668, -83.26821],[14.99852, -83.1199],[15.07544, -83.2792],[15.2451, -83.3616],[15.41198, -83.77084],[15.68188, -84.13339],[15.85633, -84.57009],[15.98047, -84.99307]]).addTo(map).bindTooltip("Gracias a Dios");


				} else if (project.department=="Intibucá") {
					polygon = L.polygon([[14.65434, -88.07057],[14.62113, -88.05409],[14.60518, -87.95384],[14.50549, -87.89753],[14.42703, -87.822],[14.39112, -87.89479],[14.3552, -87.93873],[14.28202, -87.98405],[14.23011, -88.0486],[14.14623, -88.16533],[14.10095, -88.20378],[14.02235, -88.16258],[13.98771, -88.1873],[13.99304, -88.23262],[13.91174, -88.25322],[13.87175, -88.32463],[13.85175, -88.45646],[13.97438, -88.4908],[14.07031, -88.33836],[14.18351, -88.31501],[14.21813, -88.3672],[14.31795, -88.41664],[14.4124, -88.48805],[14.46427, -88.45921],[14.50549, -88.32325],[14.63043, -88.27519],[14.65302, -88.22575],[14.64239, -88.0843]]).addTo(map).bindTooltip("Intibucá");


				} else if (project.department=="Islas de la Bahía") {
					polygon = L.polygon([[16.51312, -85.82253],[16.48152, -85.98184],[16.42621, -86.38009],[16.33134, -86.62454],[16.09926, -87.03652],[16.04911, -86.95413],[16.28917, -86.47897],[16.40776, -85.85275],[16.49996, -85.79232]]).addTo(map).bindTooltip("Islas de la Bahía");


				} else if (project.department=="La Paz") {
					polygon = L.polygon([[14.41107, -87.84398],[14.38447, -87.90989],[14.34988, -87.95109],[14.28601, -87.98268],[14.23144, -88.04173],[14.18751, -88.09941],[14.13158, -88.19142],[14.04767, -88.2024],[14.01836, -88.15846],[13.99171, -88.19142],[13.98371, -88.16258],[13.93973, -88.04036],[13.88108, -88.01976],[13.88108, -87.91951],[13.89441, -87.79042],[13.84241, -87.73686],[13.80908, -87.60365],[14.07564, -87.60777],[14.05433, -87.65309],[14.12226, -87.77256],[14.20348, -87.80003],[14.29266, -87.6064],[14.34589, -87.62974],[14.40841, -87.84398]]).addTo(map).bindTooltip("La Paz");


				} else if (project.department=="Lempira") {
					polygon = L.polygon([
						[14.95573, -88.61302],[14.94379, -88.59242],[14.95042, -88.53749],[14.86682, -88.51002],[14.82169, -88.4496],[14.86151, -88.4084],[14.83231, -88.37407],[14.79248, -88.34935],[14.73006, -88.34523],[14.72342, -88.28892],[14.60385, -88.31364],[14.57461, -88.30128],[14.4789, -88.33699],[14.4656, -88.4496],[14.45629, -88.47569],[14.37782, -88.46058],[14.32859, -88.40428],[14.23144, -88.38368],[14.20748, -88.31913],[14.13425, -88.32188],[14.04367, -88.34797],[13.97305, -88.50041],[14.02235, -88.6707],[14.10894, -88.7325],[14.19017, -88.87806],[14.22878, -88.96733],[14.32859, -88.93712],[14.3991, -88.84236],[14.36585, -88.79017],[14.41905, -88.75721],[14.50682, -88.68992],[14.60252, -88.72014],[14.69021, -88.77644],[14.73139, -88.65971],[14.81903, -88.68992],[14.91592, -88.6501]]).addTo(map).bindTooltip("Lempira");


				} else if (project.department=="Ocotepeque") {
					polygon = L.polygon([
						[14.72475, -89.12938],[14.72741, -89.00303],[14.65966, -88.96183],[14.5879, -88.89454],[14.5241, -88.84648],[14.55069, -88.71327],[14.46826, -88.7064],[14.37383, -88.78743],[14.39777, -88.83549],[14.36318, -88.86982],[14.35919, -88.90416],[14.30996, -88.94948],[14.2381, -88.96321],[14.33125, -89.02913],[14.42969, -89.34224],[14.52809, -89.28868],[14.61182, -89.14174],[14.71412, -89.13075]]).addTo(map).bindTooltip("Ocotepeque");


				} else if (project.department=="Olancho") {
					polygon = L.polygon([
						[15.36167, -86.24002],[15.63163, -85.68795],[15.45699, -85.31167],[15.29544, -85.25399],[15.17619, -84.98757],[14.73305, -84.99307],[14.67992, -85.02053],[14.56032, -85.0837],[14.57096, -85.13314],[14.44066, -85.1661],[14.29433, -85.17434],[14.20382, -85.38033],[14.07864, -85.49294],[14.04134, -85.52041],[14.18518, -86.11367],[14.34489, -86.2153],[14.30231, -86.36636],[14.37416, -86.47897],[14.3848, -86.68496],[14.6002, -86.76187],[14.64538, -86.84976],[14.85255, -86.87448],[15.01443, -86.91293],[15.20005, -86.78109],[15.35902, -86.51467],[15.40139, -86.42404],[15.32723, -86.30044]]).addTo(map).bindTooltip("Olancho");


				} else if (project.department=="Santa Bárbara") {
					polygon = L.polygon([
						[15.53639, -88.44552],[15.49669, -88.22579],[15.40139, -88.15438],[15.2345, -88.08022],[15.08074, -88.06924],[14.9481, -88.02255],[14.79945, -87.97036],[14.71711, -88.061],[14.64272, -88.06375],[14.59222, -88.28622],[14.72242, -88.31918],[14.83662, -88.36587],[14.826, -88.45376],[14.91891, -88.65426],[15.07544, -88.6213],[15.30339, -88.74215],[15.52581, -88.45925]]).addTo(map).bindTooltip("Santa Bárbara");


				} else if (project.department=="Valle") {
					polygon = L.polygon([
						[13.84141, -87.72866],[13.80674, -87.58859],[13.74272, -87.61331],[13.69736, -87.56661],[13.65466, -87.43478],[13.58259, -87.41281],[13.45173, -87.3359],[13.37158, -87.34963],[13.26467, -87.54464],[13.19783, -87.59957],[13.41166, -87.84127],[13.43303, -87.70394],[13.53453, -87.76986],[13.84141, -87.72042]]).addTo(map).bindTooltip("Valle");


				} else if (project.department=="Yoro") {
					polygon = L.polygon([
						[15.72154, -87.74789],[15.65544, -87.65176],[15.50463, -87.53915],[15.51257, -87.42105],[15.45169, -87.38259],[15.45169, -87.21231],[15.48611, -87.07772],[15.55227, -86.91293],[15.54168, -86.73989],[15.61047, -86.55313],[15.56814, -86.46249],[15.5655, -86.35262],[15.53375, -86.32241],[15.50728, -86.19607],[15.38815, -86.21255],[15.34048, -86.28121],[15.40404, -86.41305],[15.37226, -86.52841],[15.31399, -86.67947],[15.2133, -86.78384],[15.14968, -86.84426],[15.04892, -86.88821],[14.99852, -86.99807],[14.97464, -87.14364],[14.75961, -87.24801],[14.92156, -87.25625],[14.94545, -87.36611],[14.90564, -87.41281],[15.04361, -87.55013],[15.0277, -87.73965],[15.13908, -87.7424],[15.1974, -87.87698],[15.26365, -87.92916],[15.56285, -87.79183],[15.6951, -87.80557],[15.7189, -87.74514]]).addTo(map).bindTooltip("Yoro");


				} 

				polydep.push(polygon);
			},



			initMap: function(organizations) {
				map = L.map('map').setView([14.70, -86.20], 8);
				L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
					maxZoom: 18,
					attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery © <a href="http://mapbox.com">Mapbox</a>',
					id: 'mapbox.streets'
				}).addTo(map);
				for (var i = 0; i < this.organizations.length; i++) {
					var lat = this.strtoGps(this.organizations[i].latitude);
					var longi = this.strtoGps(this.organizations[i].longitude);
					if(!isNaN(lat) && !isNaN(longi)){

						/*
						var LamMarker = L.marker([lat, -1*longi],{draggable:true}).bindPopup($('<a href="#/organization/view/'+this.organizations[i]._id+'" class="speciallink">Ver Informacion de la Organizacion</a>')[0]).addTo(map);
						*/
						

						
						
						var LamMarker = L.marker([lat, -1*longi]).bindPopup($('<a href="#/organization/view/'+this.organizations[i]._id+'" class="speciallink">Ver Informacion de la Organizacion</a>')[0] ).addTo(map);

						



						gps.push([LamMarker, this.organizations[i].orgName, this.organizations[i].orgNumber, this.organizations[i].acronym, this.organizations[i].postal , this.organizations[i].department, this.organizations[i].municipality, this.organizations[i].village, this.organizations[i].community, this.organizations[i].sector, this.organizations[i].market,this.organizations[i]._id]);

					}
				};





				
				
				var popup = L.popup();

				function onMapClick(e) {
					console.log(e.latlng.toString());

				}

				map.on('click', onMapClick);
				





			},

			strtoGps: function(argument) {

				var str = argument;

				var patt = /[^\.|\d]/g
				var res = str.split(patt);

				var newArray = new Array();
				for (var i = 0; i < res.length; i++) {
					if (res[i]) {
						newArray.push(res[i]);
					}
				}

				var gps = Number(newArray[0]) + Number((newArray[1]/60)) + Number((newArray[2]/3600));

				return gps;
			},

			getOrganizations: function(){
				this.k = 1;

				this.$http.get(config.baseUrl() + '/v1/organizations').then(function(response){

					this.organizations = response.json();
					this.initMap();


				}, function(error){
					swal('Error', 'Error obteniendo las organizaciones del servidor', 'error');
				});


			},

		},

	}

</script>

<style>
	.map{ 
		height: 100% 
	}
</style>